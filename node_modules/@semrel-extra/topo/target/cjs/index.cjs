"use strict";var J=Object.create;var k=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var C=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var _=(e,s)=>{for(var t in s)k(e,t,{get:s[t],enumerable:!0})},I=(e,s,t,o)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of q(s))!S.call(e,r)&&r!==t&&k(e,r,{get:()=>s[r],enumerable:!(o=A(s,r))||o.enumerable});return e};var w=(e,s,t)=>(t=e!=null?J(C(e)):{},I(s||!e||!e.__esModule?k(t,"default",{value:e,enumerable:!0}):t,e)),Q=e=>I(k({},"__esModule",{value:!0}),e);var p=(e,s,t)=>new Promise((o,r)=>{var a=n=>{try{i(t.next(n))}catch(l){r(l)}},c=n=>{try{i(t.throw(n))}catch(l){r(l)}},i=n=>n.done?o(n.value):Promise.resolve(n.value).then(a,c);i((t=t.apply(e,s)).next())});var H={};_(H,{topo:()=>D,traverseDeps:()=>O,traverseQueue:()=>T});module.exports=Q(H);var g=require("path"),f=require("fs"),x=w(require("fast-glob"),1),E=require("toposource"),h=w(require("js-yaml"),1);var y=["dependencies","devDependencies","peerDependencies","optionalDependencies"],W=e=>p(void 0,null,function*(){let{pkgFilter:s}=e,t=yield $(e),o=yield Promise.all(t.map(r=>v(e.cwd,r)));return G(o),o.reduce((r,a)=>(s(a)&&(r[a.name]=a),r),{})}),G=e=>{let s=e.map(t=>t.name).filter((t,o,r)=>r.indexOf(t)!==o);if(s.length>0)throw new Error(`Duplicated pkg names: ${s.join(", ")}`)},v=(e,s)=>p(void 0,null,function*(){let t=(0,g.dirname)(s),o=(0,g.relative)(e,t)||".",r=(0,g.relative)(e,s),a=yield f.promises.readFile(s,"utf8"),c=JSON.parse(a);return{name:c.name,manifestRaw:a,manifestPath:s,manifestRelPath:r,manifestAbsPath:s,manifest:c,path:o,relPath:o,absPath:t}}),D=(...s)=>p(void 0,[...s],function*(e={}){let{cwd:t=process.cwd(),filter:o=u=>!0,pkgFilter:r=o,depFilter:a=u=>!0,workspaces:c,workspacesExtra:i=[]}=e,n=yield v(t,(0,g.resolve)(t,"package.json")),l={cwd:t,filter:o,depFilter:a,pkgFilter:r,workspacesExtra:i,workspaces:[...c||(yield L(n)),...i]},m=yield W(l),{edges:d,nodes:P}=M(Object.values(m).map(u=>u.manifest),a),{queue:R,graphs:F,next:N,prev:j,sources:z}=(0,E.analyze)([...d,...P.map(u=>[u])]);return{nodes:P,edges:d,queue:R,graphs:F,sources:z,prev:j,next:N,packages:m,root:n}}),L=e=>p(void 0,null,function*(){var s,t;return(Array.isArray(e.manifest.workspaces)?e.manifest.workspaces:(s=e.manifest.workspaces)==null?void 0:s.packages)||((t=e.manifest.bolt)==null?void 0:t.workspaces)||(yield p(void 0,null,function*(){try{let o=(0,g.resolve)(e.absPath,"pnpm-workspace.yaml");return h.default.load(yield f.promises.readFile(o,"utf8")).packages}catch(o){return null}}))||[]}),M=(e,s,t=y)=>{let o=e.map(({name:a})=>a).sort();return{edges:e.reduce((a,c)=>{let i=new Set;return b(c,({name:n,version:l,scope:m})=>{!i.has(n)&&o.includes(n)&&s({name:n,version:l,scope:m})&&(i.add(n),a.push([n,c.name]))},t),a},[]).sort(),nodes:o}},$=t=>p(void 0,[t],function*({workspaces:e,cwd:s}){return yield(0,x.default)(e.map(o=>B((0,g.join)(o,"package.json"))),{cwd:s,onlyFiles:!0,absolute:!0})}),B=e=>{let s=/^\\\\\?\\/.test(e),t=/[^\u0000-\u0080]+/.test(e);return s||t?e:e.replace(/\\/g,"/")},T=o=>p(void 0,[o],function*({queue:e,prev:s,cb:t}){let r={};return Promise.all(e.map(a=>r[a]=p(void 0,null,function*(){yield Promise.all((s.get(a)||[]).map(c=>r[c])),yield t(a)})))}),O=r=>p(void 0,[r],function*({packages:e,pkg:s,scopes:t=y,cb:o}){let{manifest:a}=s,c=[];b(a,({name:i,version:n,scope:l,deps:m})=>{let d=e[i];d&&c.push(Promise.resolve(o({name:i,version:n,scope:l,deps:m,pkg:d,parent:s})))},t),yield Promise.all(c)}),b=(e,s,t=y)=>{for(let o of t){let r=e[o];if(r)for(let[a,c]of Object.entries(r))s({name:a,version:c,deps:r,scope:o})}};0&&(module.exports={topo,traverseDeps,traverseQueue});
//# sourceMappingURL=index.cjs.map
